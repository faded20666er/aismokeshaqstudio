export default async function handler(req, res) {
    res.setHeader('Content-Type', 'application/json');

    const TOKEN = process.env.REPLICATE_API_TOKEN;

    if (!TOKEN) {
        return res.status(500).json({ step1: "FAIL", error: "REPLICATE_API_TOKEN is not set in environment variables" });
    }

    const results = { token_exists: true };

    try {
        // TEST 1: Is the API token valid?
        const acctRes = await fetch('https://api.replicate.com/v1/account', {
            headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        const acct = await acctRes.json();

        if (!acctRes.ok) {
            return res.status(200).json({ ...results, step2_account: "FAIL", error: "Bad API token", detail: acct });
        }
        results.step2_account = "OK";
        results.username = acct.username || acct.name || "unknown";
        results.token_type = acct.type || "unknown";

        // TEST 2: Can we hit /v1/predictions with model field?
        const test2Res = await fetch('https://api.replicate.com/v1/predictions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: "stability-ai/sdxl", input: { prompt: "golden sunset test" } })
        });
        const test2 = await test2Res.json();
        results.step3_sdxl_via_model_field = { status: test2Res.status, id: test2.id || null, prediction_status: test2.status || null, error: test2.detail || test2.title || null };

        // TEST 3: Can we hit /v1/models endpoint?
        const test3Res = await fetch('https://api.replicate.com/v1/models/stability-ai/sdxl/predictions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: { prompt: "golden sunset test 2" } })
        });
        const test3 = await test3Res.json();
        results.step4_sdxl_via_models_endpoint = { status: test3Res.status, id: test3.id || null, prediction_status: test3.status || null, error: test3.detail || test3.title || null };

        // TEST 4: Try flux-schnell (free model, always available)
        const test4Res = await fetch('https://api.replicate.com/v1/predictions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: "black-forest-labs/flux-schnell", input: { prompt: "golden sunset test 3" } })
        });
        const test4 = await test4Res.json();
        results.step5_flux_schnell = { status: test4Res.status, id: test4.id || null, prediction_status: test4.status || null, error: test4.detail || test4.title || null };

        // TEST 5: Try stable-video-diffusion
        const test5Res = await fetch('https://api.replicate.com/v1/models/stability-ai/stable-video-diffusion/predictions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: { input_image: "https://replicate.delivery/pbxt/IJEPmgAlvEhQFSBMtKRaeKPPMjGYxJMxpMH4r58FYPFjiPgA/gg_bridge.jpeg" } })
        });
        const test5 = await test5Res.json();
        results.step6_svd = { status: test5Res.status, id: test5.id || null, prediction_status: test5.status || null, error: test5.detail || test5.title || null };

        return res.status(200).json(results);

    } catch (err) {
        return res.status(500).json({ ...results, crash: err.message });
    }
}
