<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smoke Shaq Studio | Production Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --black: #0a0a0a; }
        body {
            background-color: var(--black);
            background-image: url('AISmokeShaqStudio/golddustbackdrop.jpg');
            background-size: cover;
            background-attachment: fixed;
            color: white;
            font-family: 'Inter', sans-serif;
        }
        .gold-text { color: var(--gold); font-family: 'Cinzel', serif; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        .studio-card { background: rgba(15, 15, 15, 0.9); border: 1px solid var(--gold); backdrop-filter: blur(10px); }
        .nav-btn { border-bottom: 2px solid transparent; transition: 0.3s; opacity: 0.6; }
        .nav-btn.active { border-bottom: 2px solid var(--gold); color: var(--gold); opacity: 1; }
        .tool-panel { display: none; }
        .tool-panel.active { display: block; }
        #sparkles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
    </style>
</head>
<body class="min-h-screen">
    <canvas id="sparkles"></canvas>

    <nav class="border-b border-yellow-900/30 bg-black/80 backdrop-blur-md p-4 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="AISmokeShaqStudio/logo.jpg.jpg" class="h-12 w-12 rounded-full border border-gold">
                <h1 class="gold-text text-xl font-bold tracking-widest">AI SMOKE SHAQ STUDIO</h1>
            </div>
            <div class="flex items-center gap-6">
                <div class="bg-yellow-900/20 px-4 py-1 border border-yellow-700/50 rounded-full">
                    <span class="text-xs uppercase text-gray-400">Credits:</span>
                    <span id="creditCount" class="text-gold font-bold ml-2">...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6">
        <div class="flex gap-8 mb-8 border-b border-white/10">
            <button onclick="switchTool('face-swap')" id="btn-face-swap" class="nav-btn active pb-4 text-sm uppercase">Face Swap</button>
            <button onclick="switchTool('img-to-video')" id="btn-img-to-video" class="nav-btn pb-4 text-sm uppercase">Image to Video</button>
            <button onclick="switchTool('lip-sync')" id="btn-lip-sync" class="nav-btn pb-4 text-sm uppercase">Lip Sync AI</button>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="studio-card rounded-xl p-6">
                    <h2 class="gold-text mb-4 text-lg uppercase">Input Assets</h2>
                    
                    <div id="panel-face-swap" class="tool-panel active space-y-4">
                        <label class="text-xs text-gray-400 block uppercase">Target (The Scene)</label>
                        <input type="file" id="fs-target" class="w-full bg-black/50 border border-white/10 p-2 text-xs">
                        <label class="text-xs text-gray-400 block uppercase">Face (The Person)</label>
                        <input type="file" id="fs-source" class="w-full bg-black/50 border border-white/10 p-2 text-xs">
                    </div>

                    <div id="panel-img-to-video" class="tool-panel space-y-4">
                        <label class="text-xs text-gray-400 block uppercase">Base Image</label>
                        <input type="file" id="v-image" class="w-full bg-black/50 border border-white/10 p-2 text-xs">
                        <label class="text-xs text-gray-400 block uppercase">Prompt</label>
                        <textarea id="v-prompt" placeholder="Cinematic motion..." class="w-full bg-black/50 border border-white/10 p-2 text-xs h-20 text-white"></textarea>
                    </div>

                    <div id="panel-lip-sync" class="tool-panel space-y-4">
                        <label class="text-xs text-gray-400 block uppercase">Face Video/Img</label>
                        <input type="file" id="ls-face" class="w-full bg-black/50 border border-white/10 p-2 text-xs">
                        <label class="text-xs text-gray-400 block uppercase">Audio MP3</label>
                        <input type="file" id="ls-audio" class="w-full bg-black/50 border border-white/10 p-2 text-xs">
                    </div>

                    <button onclick="handleGenerate()" id="genBtn" class="w-full mt-6 bg-gradient-to-r from-yellow-700 to-yellow-500 text-black font-bold py-3 rounded uppercase hover:brightness-110 transition">
                        Start Production
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div id="displayArea" class="studio-card rounded-xl h-full min-h-[500px] flex flex-col items-center justify-center p-8 relative">
                    <div id="loader" class="hidden absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center">
                        <div class="w-12 h-12 border-4 border-gold border-t-transparent rounded-full animate-spin"></div>
                        <p class="gold-text mt-4 animate-pulse">Rendering...</p>
                    </div>
                    <div id="resultContent" class="w-full h-full flex items-center justify-center text-center">
                        <div>
                            <img src="AISmokeShaqStudio/1.png" class="max-h-64 opacity-20 mx-auto mb-4">
                            <p class="text-gray-500 uppercase tracking-widest">Select assets and click Generate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentTool = 'face-swap';
        const userEmail = "faded206@yahoo.com";

        function switchTool(t) {
            currentTool = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${t}`));
            document.querySelectorAll('.tool-panel').forEach(p => p.classList.toggle('active', p.id === `panel-${t}`));
        }

        // Helper to convert file to Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function fetchCredits() {
            const r = await fetch(`/api/credits?email=${userEmail}`);
            const d = await r.json();
            document.getElementById('creditCount').innerText = d.credits || 0;
        }

        async function handleGenerate() {
            const loader = document.getElementById('loader');
            const resultContent = document.getElementById('resultContent');
            loader.classList.remove('hidden');

            try {
                let payload = { email: userEmail, tool: currentTool };

                // Get specific data based on tool
                if (currentTool === 'face-swap') {
                    const target = document.getElementById('fs-target').files[0];
                    const source = document.getElementById('fs-source').files[0];
                    if(!target || !source) throw new Error("Please upload both images");
                    payload.image = await toBase64(target);
                    payload.second_image = await toBase64(source);
                } 
                else if (currentTool === 'img-to-video') {
                    const img = document.getElementById('v-image').files[0];
                    if(!img) throw new Error("Please upload an image");
                    payload.image = await toBase64(img);
                    payload.prompt = document.getElementById('v-prompt').value;
                }
                else if (currentTool === 'lip-sync') {
                    const face = document.getElementById('ls-face').files[0];
                    const audio = document.getElementById('ls-audio').files[0];
                    if(!face || !audio) throw new Error("Please upload both face and audio");
                    payload.image = await toBase64(face);
                    payload.audio = await toBase64(audio);
                }

                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.output) {
                    if (currentTool === 'face-swap') {
                        resultContent.innerHTML = `<img src="${data.output}" class="max-w-full border border-gold">`;
                    } else {
                        resultContent.innerHTML = `<video src="${data.output}" controls autoplay class="max-w-full border border-gold"></video>`;
                    }
                } else {
                    alert("Error: " + (data.error || "Generation failed"));
                }
            } catch (err) {
                alert(err.message);
            } finally {
                loader.classList.add('hidden');
                fetchCredits();
            }
        }

        // Sparkle animation logic omitted for brevity but keep your canvas init here
        fetchCredits();
    </script>
</body>
</html>
